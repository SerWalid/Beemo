{% extends "tailwindBase.html" %} {% block title %} Story Time {% endblock %} {%
block header %} {% include 'navbar.html' %} {% endblock %} {% block body %}
<!-- Content -->
<div class="h-screen flex flex-col pb-6">
  <div class="h-full flex flex-col justify-center">
    <div
      class="-mt-20 max-w-4xl w-full text-center mx-auto px-4 sm:px-6 lg:px-8"
    >
      <img
        src="{{ url_for('static', filename='PageOff/assets/images/book.gif') }}"
        alt=""
        class="h-28 w-auto mx-auto mix-blend-multiply"
      />

      <h1 class="text-3xl font-bold text-gray-800 sm:text-4xl">
        Create Your Own Story!
      </h1>
      <p class="mt-3 text-gray-600">
        Use the box below to tell us what kind of story youâ€™d like. Just type in
        your ideas and hit the button to start the magic! Beemo will turn your
        ideas into a fun adventure just for you!
      </p>
    </div>

    <!-- Search -->
    <div class="mt-10 max-w-2xl w-full mx-auto px-4 sm:px-6 lg:px-8">
      <div class="relative">
        <form id="storyForm">
          <input
            type="text"
            id="storyInput"
            class="p-4 block w-full border-gray-200 border rounded-full text-sm focus:border-blue-500 focus:ring-blue-500"
            placeholder="Ask me anything..."
            required
          />
          <div class="absolute top-1/2 end-2 -translate-y-1/2">
            <button
              type="submit"
              class="size-10 inline-flex justify-center items-center gap-x-2 text-sm font-semibold rounded-full border border-transparent text-gray-500 hover:text-gray-800 focus:outline-none focus:text-gray-800"
            >
              <svg
                class="shrink-0 size-4"
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                viewBox="0 0 16 16"
              >
                <path
                  d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"
                />
              </svg>
            </button>
          </div>
        </form>
      </div>
    </div>
    <!-- End Search -->

    <!-- Loading Animation -->
    <div
      id="loading"
      class="loading fixed inset-0 flex flex-col items-center justify-center bg-black bg-opacity-50"
      style="display: none"
    >
      <img
        src="{{ url_for('static', filename='PageOff/assets/images/bmoo.gif') }}"
        alt="Loading..."
        class="h-28 w-28 mb-4"
      />
      <p class="text-white text-xl">Generating your story...</p>
    </div>

    <!-- Generated Story in Book-Like Format -->
    <div
      id="storyContainer"
      class="book-container mt-10 mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 bg-white shadow-lg rounded-lg"
      style="display: none"
    >
      <div class="relative bg-gray-100 p-6 rounded-lg">
        <div
          class="absolute -top-3 -left-3 w-5 h-5 bg-gray-100 rounded-full shadow"
        ></div>
        <div
          class="absolute -top-3 -right-3 w-5 h-5 bg-gray-100 rounded-full shadow"
        ></div>
        <div
          class="absolute -bottom-3 -left-3 w-5 h-5 bg-gray-100 rounded-full shadow"
        ></div>
        <div
          class="absolute -bottom-3 -right-3 w-5 h-5 bg-gray-100 rounded-full shadow"
        ></div>

        <h2 class="book-title text-3xl font-bold text-gray-800 text-center">
          Your Adventure
        </h2>
        <p
          id="generatedStory"
          class="book-content text-gray-700 text-lg mt-6 leading-relaxed text-justify"
        ></p>
        <audio
          id="storyAudio"
          controls
          class="mt-6 w-full"
          style="display: none"
        ></audio>
      </div>
    </div>
  </div>
</div>
<!-- End Content -->

<script>
  document
    .getElementById("storyForm")
    .addEventListener("submit", function (event) {
      event.preventDefault(); // Prevent form submission

      const storyInput = document.getElementById("storyInput").value;

      // Show loading animation
      document.getElementById("loading").style.display = "flex";
      document.getElementById("storyContainer").style.display = "none";

      fetch("/generate_story", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ story_input: storyInput }),
      })
        .then((response) => response.json())
        .then((data) => {
          // Hide loading animation
          document.getElementById("loading").style.display = "none";

          if (data.error) {
            alert("Error generating story: " + data.error);
            return;
          }

          // Display the generated story and wrap words in span tags
          document.getElementById("generatedStory").innerHTML = data.story;

          // Set and play the audio
          const audioElement = document.getElementById("storyAudio");
          audioElement.src = data.audio_url;
          audioElement.style.display = "block";
          audioElement.load();

          // Get all the words in the story
          const wordElements = document.querySelectorAll(
            "#generatedStory span"
          );

          // Assuming the total story duration is 60 seconds
          const totalDuration = 60; // Total duration in seconds
          const wordCount = wordElements.length;
          const timePerWord = totalDuration / wordCount; // Calculate time per word

          // Play the audio
          audioElement.play();

          // Highlight words as the audio plays
          audioElement.addEventListener("timeupdate", () => {
            const currentTime = audioElement.currentTime;

            // Calculate which word should be highlighted based on the elapsed time
            const currentWordIndex = Math.floor(currentTime / timePerWord);

            // Reset the previous highlights
            wordElements.forEach((word, index) => {
              if (index <= currentWordIndex) {
                word.classList.add("highlight");
              } else {
                word.classList.remove("highlight");
              }
            });
          });

          // Show the story container
          document.getElementById("storyContainer").style.display = "block";

          // Scroll smoothly to the story section after loading
          document
            .getElementById("storyContainer")
            .scrollIntoView({ behavior: "smooth" });
        })
        .catch((error) => {
          console.error("Error generating story:", error);
          document.getElementById("loading").style.display = "none";
        });
    });

  // Style for highlighted words
  const style = document.createElement("style");
  style.innerHTML = `
  .highlight {
    background-color: yellow;
    font-weight: bold;
  }
`;
  document.head.appendChild(style);
</script>

{% endblock %}
